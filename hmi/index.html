
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../techref/">
      
      
        <link rel="next" href="../links/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.10">
    
    
      
        <title>HMI - MODAQ 2.0 (M2)</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e359304.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#m2-hmi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="MODAQ 2.0 (M2)" class="md-header__button md-logo" aria-label="MODAQ 2.0 (M2)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MODAQ 2.0 (M2)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              HMI
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="MODAQ 2.0 (M2)" class="md-nav__button md-logo" aria-label="MODAQ 2.0 (M2)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    MODAQ 2.0 (M2)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../github/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Github
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Software
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../techref/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Technical Reference
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    HMI
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    HMI
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      nginx Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="nginx Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-user-permissions-to-nginx-web-page-folder" class="md-nav__link">
    <span class="md-ellipsis">
      Set User Permissions to nginx Web Page Folder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-nginx-virtual-server-configuration-file-for-hmi" class="md-nav__link">
    <span class="md-ellipsis">
      Create nginx Virtual Server Configuration File for HMI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ubuntu-firewall-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Ubuntu Firewall Rules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rosbridge-server" class="md-nav__link">
    <span class="md-ellipsis">
      ROSBridge Server
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-client-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Web Client Framework
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Web Client Framework">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-hmi-design-elements" class="md-nav__link">
    <span class="md-ellipsis">
      Basic HMI Design Elements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basic HMI Design Elements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#roslib-subscriber" class="md-nav__link">
    <span class="md-ellipsis">
      roslib Subscriber
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roslib-publisher" class="md-nav__link">
    <span class="md-ellipsis">
      roslib Publisher
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traffic-lights" class="md-nav__link">
    <span class="md-ellipsis">
      Traffic Lights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streaming-charts" class="md-nav__link">
    <span class="md-ellipsis">
      Streaming Charts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Useful Links
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      nginx Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="nginx Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-user-permissions-to-nginx-web-page-folder" class="md-nav__link">
    <span class="md-ellipsis">
      Set User Permissions to nginx Web Page Folder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-nginx-virtual-server-configuration-file-for-hmi" class="md-nav__link">
    <span class="md-ellipsis">
      Create nginx Virtual Server Configuration File for HMI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ubuntu-firewall-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Ubuntu Firewall Rules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rosbridge-server" class="md-nav__link">
    <span class="md-ellipsis">
      ROSBridge Server
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-client-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Web Client Framework
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Web Client Framework">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-hmi-design-elements" class="md-nav__link">
    <span class="md-ellipsis">
      Basic HMI Design Elements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basic HMI Design Elements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#roslib-subscriber" class="md-nav__link">
    <span class="md-ellipsis">
      roslib Subscriber
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roslib-publisher" class="md-nav__link">
    <span class="md-ellipsis">
      roslib Publisher
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traffic-lights" class="md-nav__link">
    <span class="md-ellipsis">
      Traffic Lights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streaming-charts" class="md-nav__link">
    <span class="md-ellipsis">
      Streaming Charts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<style>
    img[src*='#left'] {
     float: left;
    }
    img[src*='#right'] {
        float: right;
    }
    img[src*='#center'] {
        display: block;
        margin: auto;
    }
</style>

<h1 id="m2-hmi">M2 HMI <img alt="MODAQ M2 HMI Example Design" src="../img/m2_logo.png#right" /><a class="headerlink" href="#m2-hmi" title="Permanent link">&para;</a></h1>
<p></p>
A Human-Machine Interface, or HMI, is a control panel or portal that enables high-speed, near realtime interaction with M2. It can display or plot values and allow for operator control of specifically coded elements running in M2- such as manual control of a relay. </p>
<p><img alt="" src="../img/M2_HMI_screenshot.png#center" /></p>
<p>Typically, the HMI would be referred to as the <em>frontend</em>, while the bulk of the MODAQ code responsible for the actual data acquisition, control outputs, and general logic is considered the <em>backend</em>. </p>
<p>M2 uses a standard web development stack consisting of HTML, JavaScript (JS), and CSS to render the HMI. A web server runs on the M2 controller and users (clients) connect to the HMI using their web browser. For security purposes, the HMI is only accessible if the client is on the same subnet as the M2 controller. Remote access from anywhere in the world could be accomplished using a VPN gateway.  </p>
<p>The frontend and backend communicates through the use of a <a href="https://www.tutorialspoint.com/html5/html5_websocket.htm" target="_blank">websocket</a>, which provides a dynamic, bidirectional interface to exchange data through ROS2 topics or services.</p>
<h2 id="getting-started">Getting Started<a class="headerlink" href="#getting-started" title="Permanent link">&para;</a></h2>
<p>This will not be a detailed tutorial and it assumes some familiarity with the ROS2 environment, Linux terminal, and web server/client basics. These are the following minimum requirements to get an M2 HMI up and running:</p>
<p>Backend:</p>
<ul>
<li>ROS2 Humble installed on the M2 controller. This requirement should already be met if ROS2 was installed in the previous section on getting MODAQ up and running. </li>
<li><a href="https://github.com/RobotWebTools/rosbridge_suite" target="_blank">rosbridge_suite</a>. This creates the backend service to allow frontend interaction with the ROS2 environment. </li>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/install/#official-debian-ubuntu-packages" target="_blank">nginx</a> web server. Web servers such as lighttp, the venerable Apache, or numerous others could be used instead of nginx. The choice of web server is mostly inconsequential as long as it supports modern web technologies and is reasonably lightweight. We will only provide guidance for configuration and use of nginx. </li>
<li>At least one ROS2 node running on the M2 controller as publisher and optionally a subscriber node. </li>
</ul>
<p>Frontend:</p>
<ul>
<li>An IDE or text editor for composing the web documents. If you're using VS Code for ROS2, that will work fine.</li>
<li><a href="https://github.com/RobotWebTools/roslibjs" target="_blank">roslibjs</a>. This will be installed as part of the rosbridge_suite on the backend, but needs to be 'visible' to the web server. Visibility might involve providing the correct path to the library or our preference, place of copy of the <a href="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js" target="_blank">minified</a> (<a href="https://github.com/RobotWebTools/roslibjs/blob/ros2/build/roslib.min.js" target="_blank">alternative link</a>) roslib in the /js folder in your nginx html document root.<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> </li>
<li><a href="https://www.chartjs.org/" target="_blank">chart.js v3.3.2</a><sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> (<a href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.3.2/chart.min.js" target="_blank">minified</a>). This is only required if you want to have plots in your HMI. </li>
<li><a href="https://nagix.github.io/chartjs-plugin-streaming/master/" target="_blank">chartjs-plugin-streaming</a> <a href="https://github.com/nagix/chartjs-plugin-streaming/releases/download/v2.0.0/chartjs-plugin-streaming.min.js" target="_blank">(minified)</a>. and its dependencies<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> (which are noted in its Getting Started section of the chartjs-plugin-streaming webpage linked in the last sentence). This is only required if you intend to have plots in your HMI and want those plots to update in near realtime (AKA streaming).</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code uses offline versions of each of these libraries, which allows the HMI to operate without needing to have an active internet connection for dynamically loading the libraries from a Content Delivery Network (CDN). Because of this, the libraries are frozen in time and may not have the latest and greatest features and will lack security updates and bugfixes. At this point, the libraries appear to be sufficiently stable and since the HMI is served on a private subnet, security should not be an issue. It should be cautioned to only use the versions of those libraries that the code was originally written for, since different versions can break stuff.</p>
<p>Further, getting offline versions of JS libraries is becoming more difficult. It used to be a given that a library would have a simple and clear link to the offline version, but that is slowly changing. Since most web servers are by nature 'online', it makes sense to pull the libraries as needed from a CDN which should assure the libraries are up to date, with all recent bugfixes and security patches. This is also smart from a marketing/tracking perspective, since the developer can have a better feel for the userbase and popularity of their scripts. However, CDNs can go down, scripts can be moved to different CDNs, developers can pull/change features or alter the licensing terms, or there can be network issues causing the script not to load, so for mission critical stuff and particularly if this server does not have continuous internet access, an offline version is necessary</p>
</div>
<h3 id="nginx-configuration">nginx Configuration<a class="headerlink" href="#nginx-configuration" title="Permanent link">&para;</a></h3>
<p>nginx can be install with the following terminal command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>sudo apt install nginx
</span></code></pre></div>
<p>Configuration of nginx will live in these folders:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>/etc/nginx/sites-available
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>/etc/nginx/sites-enabled
</span></code></pre></div>
<p>The website (HMI) is hosted from the <code>/var/www/</code> folder by default. Multiple websites can be hosted simultaneously with nginx and they can be kept organized in their own folders. This discussion will assume a folder called <code>modaq_hmi</code> was created in <code>/var/www/</code></p>
<p>Since the config and content folders live in root, permissions will be necessary to manipulate these files from a standard user account. Using temporary privilege escalation (<code>sudo</code>) will suffice for the nginx configuration files, but this can get tedious for the HMI content pages. Best Practices would be to edit these files in user space (i.e. a folder downstream of the user's /home folder) and include them in version control (github), then copy them to the production space (<code>/var/www/modaq_hmi</code>) when ready to take them live.</p>
<h4 id="set-user-permissions-to-nginx-web-page-folder">Set User Permissions to nginx Web Page Folder<a class="headerlink" href="#set-user-permissions-to-nginx-web-page-folder" title="Permanent link">&para;</a></h4>
<p>While this is optional, it will make life easier during the dev process to add user permissions to thw <code>/var/www/modaq_hmi</code> folder. Otherwise, every single change will require sudo privilege escalation.  </p>
<p>This sets the local user 'modaq' with rwx privileges in the modaq_hmi folder recursively:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>sudo setfacl -R -m u:modaq:rwx /var/www/modaq_hmi
</span></code></pre></div>
<p>It may be necessary to do a chmod afterwards:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo chmod -R 755 /var/www/modaq_hmi
</span></code></pre></div>
<h4 id="create-nginx-virtual-server-configuration-file-for-hmi">Create nginx Virtual Server Configuration File for HMI<a class="headerlink" href="#create-nginx-virtual-server-configuration-file-for-hmi" title="Permanent link">&para;</a></h4>
<p>As noted earlier, nginx creates two folders for the server configuration. The <code>sites-available</code> folder contains the configurations for one or more websites, while the <code>sites-enabled</code> folder contain the configuration(s) for the site(s) that nginx is currently serving. Think of <code>sites-available</code> as the parking area and <code>sites-enabled</code> as the active/production area. Instead of actually moving or copying the configuration file to the <code>sites-enabled</code> folder, nginx expects only a <a href="https://www.geeksforgeeks.org/how-to-symlink-a-file-in-linux/" target="_blank">symbolic link</a> to the file in the <code>sites-available</code> folder. The following shows the contents of a configuration file that works for us:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="l l-Scalar l-Scalar-Plain">server {</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">listen 80;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">listen [::]:80;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">root /var/www;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain"># Add index.php to the list if you are using PHP</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">index index.html index.htm;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain"># For this to work, needs DNS resolution or entry in</span><span class="w"> </span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain"># hosts files on client computer</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">server_name modaq.hmi www.modaq.hmi;</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">location / {</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># First attempt to serve request as file, then</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># as directory, then fall back to displaying a 404.</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">try_files $uri $uri/ =404;</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"> </span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="l l-Scalar l-Scalar-Plain">}</span>
</span></code></pre></div>
<p>A couple of notes about this configuration: </p>
<ol>
<li>This configuration is for an unsecured connection (i.e. not https://) and is probably safe for the private subnet which serves this HMI. However, the commented section on <code>SSL configuration</code> could be enabled to provide secure connections- if certificate dependencies are met. Some web browsers might complain about connecting to the HMI citing that the connection is unsecure and potentially dangerous if SSL is not enabled. It may be necessary to click through some warnings or whitelist the site. </li>
<li>The entry for <code>server_name</code> was an attempt allow users to type modaq.hmi into their browser instead of having to know the IP address of the controller. While that would be convenient, more work needs to be done to get it working, so we backburnered this for other priorities. </li>
</ol>
<h4 id="ubuntu-firewall-rules">Ubuntu Firewall Rules<a class="headerlink" href="#ubuntu-firewall-rules" title="Permanent link">&para;</a></h4>
<p>If the Ubuntu firewall (<code>ufw</code>) is enabled on the controller, it may be necessary to create a firewall rule to allow nginx to access the network. This is done with a simple terminal command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>sudo ufw allow &#39;Nginx HTTP&#39;
</span></code></pre></div>
<h2 id="rosbridge-server">ROSBridge Server<a class="headerlink" href="#rosbridge-server" title="Permanent link">&para;</a></h2>
<p>The primary mechanism providing connectivity between ROS2 nodes running on M2 and the nginx web server is a websocket that is managed through rosbridge and roslibjs. Rosbridge is the service running along with M2 ROS2 nodes and exposes all published topics to a websocket.</p>
<p>If the rosbridge_suite was properly installed, the rosbridge server can be started with this command:</p>
<p><code>ros2 run rosbridge_server rosbridge_websocket</code></p>
<p>It's recommended to add this as the last item in the M2 launch file so that it starts automatically with the rest of the ROS2 nodes.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Node(
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    package=&#39;rosbridge_server&#39;,
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    executable=&#39;rosbridge_websocket&#39;,
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    name=&#39;rosbridge&#39;
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>)
</span></code></pre></div>
<h2 id="web-client-framework">Web Client Framework<a class="headerlink" href="#web-client-framework" title="Permanent link">&para;</a></h2>
<p>There are four main parts of the web code that are necessary for pub/sub with ROS2 on the M2 system</p>
<ol>
<li>Establish the websocket connection to ROSBridge </li>
<li>Create a listener for ROS2 topics (subscribe) and/or define a topic to publish</li>
<li>Handle incoming/outgoing messages</li>
<li>Create the user interface (actual webpage)</li>
</ol>
<h3 id="basic-hmi-design-elements">Basic HMI Design Elements<a class="headerlink" href="#basic-hmi-design-elements" title="Permanent link">&para;</a></h3>
<p>The M2 HMI uses a simple but effective grid of tiles to organize the content. This is accomplished through a hierarchy of <code>&lt;div&gt;</code> tags to define the sections (or <i>div</i>isions) with attributes applied from CSS classes. </p>
<p>In this public release, these basic features are included in the HMI:</p>
<ol>
<li>Traffic Lights - These are multi-modal text boxes that can change color based on logic contained in the accompanying JS. The traffic lights can be used to indicate whether a parameter is nearing or exceeding defined thresholds or indicate an alarm condition.</li>
<li>Scalar Data -  Display the current numeric value of certain parameters from a subscribed topic.</li>
<li>Streaming Plots - The examples include single and multivariate plots, as well as dual y-axis plots. </li>
<li>Boolean Tick Boxes - These allow publishing boolean values back to M2 that can be used for manual control or setting the state of certain features. </li>
<li>Text/Numeric Entry Boxes - These can publish numeric or text values to M2.</li>
</ol>
<p>Since everything is written in ordinary HTML/JS/CSS and a handful of publicly available JS libraries, users can easily leverage these examples to develop a customized HMI suitable for their application. </p>
<p>The tile system (aka <a href="https://www.w3schools.com/css/css_grid.asp" target="_blank">grid</a>) is quite flexible, allowing one to many content tiles on each row. While the height of each row can be constrained, the example included in this repo allows the height to grow to fill the content. The width of each tile is constrained to a fraction of the overall width allowed by the top-level (parent) div container. </p>
<p>Diving deeper, the parent div is configured with 4 available columns in the included <code>style.css</code> file and looking at the screen shot of the HMI page at the beginning of this section, the MODAQ banner is allowed to span 3 columns in width, while the rosbridge status tile is set to 1 column- for a grand total of 4 columns. </p>
<h4 id="roslib-subscriber">roslib Subscriber<a class="headerlink" href="#roslib-subscriber" title="Permanent link">&para;</a></h4>
<p>roslib.js is a javascript library used on the webserver that can subscribe to topics published on M2 and display the data in a webpage. In addition it allows for publication of topics from the webpage as well as using or creating services.</p>
<p>First, an object is created to establish the websocket connection to the ROS2 instance on the M2 controller (showing the most relevant code snippet):</p>
<p><code>const ros = new ROSLIB.Ros({ url: "ws://localhost:9090" });</code><sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup></p>
<p>Next, a listener object is created to subscribe to the desired topic being published on the controller. In this example we have a temperature and humidity sensor that is acquired in M2 using MODBUS TCP and the scaled data are published to the <code>ths</code> topic. </p>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// MODBUS Temperature and Humidity Sensor</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kd">var</span><span class="w"> </span><span class="nx">ths_listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ROSLIB</span><span class="p">.</span><span class="nx">Topic</span><span class="p">({</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="nx">ros</span><span class="o">:</span><span class="w"> </span><span class="nx">ros</span><span class="p">,</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/ths&#39;</span><span class="p">,</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="nx">messageType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ths_modbus/msg/Th&#39;</span><span class="p">,</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="nx">throttle_rate</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="c1">// throttle_rate sets update interval in ms</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="p">});</span>
</span></code></pre></div>
<p>When a new message is received, it's copied to a variable with global scope for further manipulation within the curly braces. </p>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nx">ths_listener</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="c1">// copy ROS data to var with global scope</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="nx">ths_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">;</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="c1">// do stuff here with the topic data</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="p">});</span>
</span></code></pre></div>
<h4 id="roslib-publisher">roslib Publisher<a class="headerlink" href="#roslib-publisher" title="Permanent link">&para;</a></h4>
<p>The roslib publisher follows a similar pattern to the Subcriber, first a topic object is created:</p>
<p><div class="language-javascript highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kd">var</span><span class="w"> </span><span class="nx">hmiCtl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ROSLIB</span><span class="p">.</span><span class="nx">Topic</span><span class="p">({</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="nx">ros</span><span class="o">:</span><span class="w"> </span><span class="nx">ros</span><span class="p">,</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/hmi_ctl&#39;</span><span class="p">,</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="nx">messageType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;modaq_messages/msg/Hmi&#39;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="p">});</span>
</span></code></pre></div>
We had previously created a unique message schema for the HMI in ROS2 on the M2 controller and included it during the build process, which includes the parameters we want to publish from the HMI.  </p>
<p>An event listener is bound to the "Push to MODAQ" button in the HMI, triggering a read of the user controls... </p>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kd">var</span><span class="w"> </span><span class="nx">hmiPub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ROSLIB</span><span class="p">.</span><span class="nx">Message</span><span class="p">({</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="nx">override</span><span class="o">:</span><span class="w"> </span><span class="nx">user_override</span><span class="p">,</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="nx">do0</span><span class="o">:</span><span class="w"> </span><span class="nx">user_do0</span><span class="p">,</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="nx">do1</span><span class="o">:</span><span class="w"> </span><span class="nx">user_do1</span><span class="p">,</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="nx">do2</span><span class="o">:</span><span class="w"> </span><span class="nx">user_do2</span><span class="p">,</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="nx">do3</span><span class="o">:</span><span class="w"> </span><span class="nx">user_do3</span><span class="p">,</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="nx">int1</span><span class="o">:</span><span class="w"> </span><span class="nx">user_int1</span><span class="p">,</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">    </span><span class="nx">message1</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hello Casey&#39;</span><span class="p">,</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="nx">message2</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hello Aidan&#39;</span><span class="p">,</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="nx">float2</span><span class="o">:</span><span class="w"> </span><span class="mf">3.17</span><span class="p">,</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">    </span><span class="nx">header</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">        </span><span class="nx">frame_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>and publishes them.
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>hmiCtl.publish(hmiPub);
</span></code></pre></div></p>
<h4 id="traffic-lights">Traffic Lights<a class="headerlink" href="#traffic-lights" title="Permanent link">&para;</a></h4>
<p>The appearance of the traffic lights is done with CSS and the color change is triggered by some JS logic. </p>
<p><div class="language-javascript highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ths_data</span><span class="p">.</span><span class="nx">humidity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">90</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;status1&quot;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&lt;span class=&#39;traffic_light false&#39;&gt;Humidity&lt;/span&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ths_data</span><span class="p">.</span><span class="nx">humidity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">65</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;status1&quot;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&lt;span class=&#39;traffic_light warn&#39;&gt;Humidity&lt;/span&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;status1&quot;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&lt;span class=&#39;traffic_light true&#39;&gt;Humidity&lt;/span&gt;&quot;</span><span class="p">;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
In this snippet, if the humidity is &gt;90, the traffic light identified by the tag <code>status1</code> is styled using a combination of two CSS classes: <code>traffic_light false</code>, which in this case will color it red. Similarly, if it's &gt;65, it's colored yellow, otherwise it's green. </p>
<h4 id="streaming-charts">Streaming Charts<a class="headerlink" href="#streaming-charts" title="Permanent link">&para;</a></h4>
<p>We chose chart.js as the charting engine for the M2 HMI, since it's highly customizable, capable, and looks good. It also has great support (both from the developer and user community), which is important, since it can be a little complicated to use. Because of this complexity, this section will not go into detail on its use, but will point out a few details around getting the streaming to work correctly - particularly with multivariate/dual-axis plots. </p>
<p>chart.js, without the <code>chartjs-plugin-streaming</code> plugin, expects to be passed a static numeric array and it renders into a plot
with the selected attributes. The streaming plugin (basically) creates a fifo buffer for the data points and animates them on the x-axis.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>limit the chart history in order to assure smooth operation- especially with multiple charts on a single HMI page.</p>
</div>
<p>The architecture of the HMI web stack purposely places the computational burden of chart composition and rendering on the web client (i.e. your browser) not the M2 controller. Therefore, low-powered computers may struggle with smooth animation if the HMI has a lot of plots and/or the chart history is too big. The example included in this repo updates the chart at 1 Hz and displays up to 1 minute of data history. The update rate and history depth can be adjusted to preference.</p>
<p>chart.js breaks up the chart composition into 3 blocks: setup, config, and render. The setup block defines the y-axis datasets, labels, and plot trace attributes. The config block expands on this by defining additional attributes and binding the dataset(s) to an object that gets rendered in the render block. This all expects the data to formatted as an array, however our data are constructed into objects. </p>
<p>To overcome this, we define a object literal to map the y-axis label(s) to the label used to identify the desired element in the data object (example for the accelerometer data). </p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>const dataMap = { Ax: &#39;ax&#39;, Ay: &#39;ay&#39;, Az: &#39;az&#39; };
</span></code></pre></div>
Then we insert each data point into the chart object:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>chart.data.datasets.forEach(dataset =&gt; {
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    dataset.data.push({
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>        x: Date.now(),
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        y: mpu6050_data[dataMap[dataset.label]],
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    });
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>});
</span></code></pre></div>
<blockquote>
<p>Side Note - We typically use high quality inertial sensors in our projects and eagle-eyed readers will notice the MPU-6050 referenced in a few places in this documentation and the github repo. The MPU-6050 is a &lt;$5 sensor that has some utility in the occasional low-cost/low demand applications (see: <a href="https://github.com/NREL/MODAQ-BB" target="_blank">MODAQ-BB</a>). </p>
</blockquote>
<p>Similarly, handling a multivariate data object and plotting with dual y-axes took some creativity, but is simpler as long as only 2 parameters are plotted:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>chart.data.datasets.forEach(dataset =&gt; {
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    dataset.data.push({
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>        x: Date.now(),
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>        y: dataset.label === &#39;Temperature&#39; ? ths_data.temperature : ths_data.humidity
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    });
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>});
</span></code></pre></div>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Using the minified version of any of the required JS libraries is totally optional. We prefer minified, since it's a smaller overall payload and can improve performance. The disadvantage to using minified libraries is that all unnecessary whitespace characters are removed, so inspecting or edited the library code can be very difficult- even though it's still in plain text.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>We're using chartjs v3.3.2 since at the time we were creating the HMI there were compatibility issues with the plugin-streaming library on v4 and higher. That may have been resolved in later releases of plugin-streaming.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Since finding the dependencies as minified libraries in the correct version can be a bit of a pain, here are direct links: <a href="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js" target="_blank">luxon v3.4.40<a/> and <a href="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0" target="_blank">chartjs-adapter-luxon v1.0.0</a>&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Replace 'localhost' with the IP address of the M2 controller hosting the HMI webpage.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>